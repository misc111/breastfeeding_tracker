<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#c084fc">
    <title>Baby Feed Tracker</title>
    <link rel="manifest" href="manifest.json">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;

        // ============================================
        // UTILS - Constants
        // ============================================
        const FeedingSide = {
            Left: 'Left',
            Right: 'Right'
        };
        const TEN_MINUTES_MS = 10 * 60 * 1000;

        // ============================================
        // UTILS - Feed Logic
        // ============================================
        function addFeedLogic(history, newSingleFeed) {
            const newHistory = [...history];

            if (newHistory.length > 0) {
                const lastUnit = newHistory[0];
                const timeDiff = newSingleFeed.endTime - lastUnit.endTime;

                if (lastUnit.sessions.length === 1 &&
                    lastUnit.sessions[0].side !== newSingleFeed.side &&
                    timeDiff < TEN_MINUTES_MS) {
                    lastUnit.sessions.push(newSingleFeed);
                    lastUnit.endTime = newSingleFeed.endTime;
                    return newHistory;
                }
            }

            const newUnit = {
                id: `${Date.now()}-${Math.random()}`,
                sessions: [newSingleFeed],
                endTime: newSingleFeed.endTime
            };
            return [newUnit, ...newHistory];
        }

        // ============================================
        // UTILS - Time Formatting
        // ============================================
        function formatTimerDisplay(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;

            if (hours > 0) {
                return `${hours}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }
            return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function formatTime(date) {
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }

        // ============================================
        // UTILS - Statistics
        // ============================================
        function calculateDailyStats(history, targetDate) {
            const today = new Date(targetDate);
            today.setHours(0, 0, 0, 0);

            const todayFeeds = history.filter(unit => {
                const feedDate = new Date(unit.endTime);
                feedDate.setHours(0, 0, 0, 0);
                return feedDate.getTime() === today.getTime();
            });

            const totalFeeds = todayFeeds.length;
            const totalTime = todayFeeds.reduce((sum, unit) => {
                return sum + unit.sessions.reduce((s, session) => s + session.duration, 0);
            }, 0);
            const leftTime = todayFeeds.reduce((sum, unit) => {
                return sum + unit.sessions.filter(s => s.side === FeedingSide.Left).reduce((s, session) => s + session.duration, 0);
            }, 0);
            const rightTime = todayFeeds.reduce((sum, unit) => {
                return sum + unit.sessions.filter(s => s.side === FeedingSide.Right).reduce((s, session) => s + session.duration, 0);
            }, 0);

            return { totalFeeds, totalTime, leftTime, rightTime };
        }

        function calculateMonthlyStats(history, currentMonth, currentYear) {
            const monthFeeds = history.filter(unit => {
                const feedDate = new Date(unit.endTime);
                return feedDate.getMonth() === currentMonth && feedDate.getFullYear() === currentYear;
            });

            if (monthFeeds.length === 0) {
                return { totalFeeds: 0, avgFeedsPerDay: 0 };
            }

            const totalFeeds = monthFeeds.length;
            const uniqueDays = new Set(monthFeeds.map(unit => {
                const date = new Date(unit.endTime);
                return `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`;
            })).size;
            const avgFeedsPerDay = (totalFeeds / uniqueDays).toFixed(1);

            return { totalFeeds, avgFeedsPerDay };
        }

        // ============================================
        // HOOKS - useTimer
        // ============================================
        function useTimer() {
            const [activeSide, setActiveSide] = useState(null);
            const [duration, setDuration] = useState(0);

            useEffect(() => {
                if (activeSide === null) return;
                const interval = setInterval(() => {
                    setDuration(d => d + 1);
                }, 1000);
                return () => clearInterval(interval);
            }, [activeSide]);

            const startTimer = useCallback((side) => {
                setActiveSide(side);
                setDuration(0);
            }, []);

            const stopTimer = useCallback(() => {
                const feed = {
                    side: activeSide,
                    duration: duration,
                    endTime: Date.now()
                };
                setActiveSide(null);
                setDuration(0);
                return feed;
            }, [activeSide, duration]);

            return { activeSide, duration, startTimer, stopTimer };
        }

        // ============================================
        // HOOKS - useFeedingHistory
        // ============================================
        function useFeedingHistory() {
            const [history, setHistory] = useState(() => {
                const saved = localStorage.getItem('feedingHistory');
                return saved ? JSON.parse(saved) : [];
            });

            useEffect(() => {
                localStorage.setItem('feedingHistory', JSON.stringify(history));
            }, [history]);

            const addFeed = useCallback((newSingleFeed) => {
                setHistory(prevHistory => addFeedLogic(prevHistory, newSingleFeed));
            }, []);

            useEffect(() => {
                if (history.length === 0) return;
                const lastUnit = history[0];
                if (lastUnit.sessions.length !== 1) return;

                const timeSinceLastFeed = Date.now() - lastUnit.endTime;
                const delay = Math.max(0, TEN_MINUTES_MS - timeSinceLastFeed);

                const timeout = setTimeout(() => {
                    setHistory(prevHistory => {
                        const newHistory = [...prevHistory];
                        const unit = newHistory[0];
                        if (unit.sessions.length === 1) {
                            const missingSide = unit.sessions[0].side === FeedingSide.Left ? FeedingSide.Right : FeedingSide.Left;
                            unit.sessions.push({
                                side: missingSide,
                                duration: 0,
                                endTime: unit.endTime
                            });
                        }
                        return newHistory;
                    });
                }, delay);

                return () => clearTimeout(timeout);
            }, [history]);

            const clearHistory = useCallback(() => {
                if (window.confirm('Are you sure you want to clear all feeding history?')) {
                    setHistory([]);
                    localStorage.removeItem('feedingHistory');
                }
            }, []);

            const lastFeedTime = history.length > 0 ? history[0].endTime : null;
            const chronologicalHistory = useMemo(() => [...history].reverse(), [history]);

            return { history, addFeed, clearHistory, lastFeedTime, chronologicalHistory };
        }

        // ============================================
        // COMPONENTS - TimerDisplay
        // ============================================
        function TimerDisplay({ seconds }) {
            return formatTimerDisplay(seconds);
        }

        // ============================================
        // COMPONENTS - StatCard
        // ============================================
        function StatCard({ title, value }) {
            return (
                <div className="bg-white p-6 rounded-lg shadow-lg">
                    <div className="text-xs uppercase text-slate-500 font-semibold mb-2">{title}</div>
                    <div className="text-3xl font-bold text-slate-800">{value}</div>
                </div>
            );
        }

        // ============================================
        // COMPONENTS - HistoryLog
        // ============================================
        function HistoryLog({ chronologicalHistory }) {
            if (chronologicalHistory.length === 0) {
                return (
                    <div className="text-slate-500 text-center py-8">
                        No feedings logged yet.
                    </div>
                );
            }

            const groupedByDay = {};
            chronologicalHistory.forEach(unit => {
                const date = new Date(unit.endTime);
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);

                let dayLabel;
                if (date.toDateString() === today.toDateString()) {
                    dayLabel = 'Today';
                } else if (date.toDateString() === yesterday.toDateString()) {
                    dayLabel = 'Yesterday';
                } else {
                    dayLabel = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                }

                if (!groupedByDay[dayLabel]) {
                    groupedByDay[dayLabel] = [];
                }
                groupedByDay[dayLabel].push(unit);
            });

            return (
                <div className="space-y-4">
                    {Object.entries(groupedByDay).map(([day, units]) => (
                        <div key={day} className="bg-white p-4 rounded-lg shadow-lg">
                            <h3 className="font-bold text-slate-800 mb-3">{day}</h3>
                            <div className="space-y-3">
                                {units.map((unit, idx) => {
                                    const startTime = new Date(unit.sessions[0].endTime - unit.sessions[0].duration * 1000);
                                    const endTime = new Date(unit.endTime);
                                    const isPending = unit.sessions.length === 1;

                                    let timeSinceLastFeed = '';
                                    if (idx > 0) {
                                        const prevUnit = units[idx - 1];
                                        const prevEndTime = new Date(prevUnit.endTime);
                                        const diffMs = startTime - prevEndTime;
                                        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                                        const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                                        timeSinceLastFeed = `(${diffHours}h ${diffMins}m)`;
                                    }

                                    return (
                                        <div key={unit.id} className="border-l-4 border-violet-400 pl-3">
                                            <div className="text-sm text-slate-600">
                                                {formatTime(startTime)}
                                                {!isPending && <> - {formatTime(endTime)}</>}
                                                {isPending && <span className="ml-2 text-rose-500">- Pending...</span>}
                                                {timeSinceLastFeed && <span className="ml-2 text-slate-400">{timeSinceLastFeed}</span>}
                                            </div>
                                            <div className="flex gap-2 mt-2">
                                                {unit.sessions.map((session, i) => (
                                                    <div key={i} className={`flex items-center gap-2 px-3 py-1 rounded-full ${session.side === FeedingSide.Left ? 'bg-violet-100 text-violet-700' : 'bg-rose-100 text-rose-700'}`}>
                                                        <span className="font-bold">{session.side[0]}</span>
                                                        <span className="text-sm"><TimerDisplay seconds={session.duration} /></span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    ))}
                </div>
            );
        }

        // ============================================
        // PAGES - TrackerPage
        // ============================================
        function TrackerPage({ activeSide, duration, startTimer, stopTimer, addFeed, clearHistory, chronologicalHistory }) {
            const handleButtonClick = (side) => {
                if (activeSide === null) {
                    startTimer(side);
                } else if (activeSide === side) {
                    const feed = stopTimer();
                    addFeed(feed);
                }
            };

            return (
                <div className="flex flex-col h-full">
                    <div className="p-6 text-center">
                        {activeSide === null ? (
                            <div className="text-slate-500 text-lg">Tap L or R to start a feed</div>
                        ) : (
                            <>
                                <div className="text-slate-600 mb-2">Feeding on {activeSide} side</div>
                                <div className="text-6xl font-bold text-slate-800">
                                    <TimerDisplay seconds={duration} />
                                </div>
                            </>
                        )}
                    </div>

                    {chronologicalHistory.length > 0 && (
                        <div className="px-4 flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold text-slate-800">Feeding History</h2>
                            <button
                                onClick={clearHistory}
                                disabled={activeSide !== null}
                                className="px-4 py-2 bg-red-500 text-white rounded-lg disabled:bg-slate-300 disabled:cursor-not-allowed"
                            >
                                Clear
                            </button>
                        </div>
                    )}

                    <div className="flex-grow overflow-y-auto px-4 pb-4">
                        <HistoryLog chronologicalHistory={chronologicalHistory} />
                    </div>

                    <div className="p-6 flex gap-4 justify-center">
                        <button
                            onClick={() => handleButtonClick(FeedingSide.Left)}
                            disabled={activeSide !== null && activeSide !== FeedingSide.Left}
                            className={`w-24 h-24 rounded-full text-white text-4xl font-bold shadow-lg active:scale-95 transition-transform disabled:opacity-50 disabled:cursor-not-allowed ${
                                activeSide === FeedingSide.Left ? 'bg-red-600' : 'bg-violet-400'
                            }`}
                        >
                            L
                        </button>
                        <button
                            onClick={() => handleButtonClick(FeedingSide.Right)}
                            disabled={activeSide !== null && activeSide !== FeedingSide.Right}
                            className={`w-24 h-24 rounded-full text-white text-4xl font-bold shadow-lg active:scale-95 transition-transform disabled:opacity-50 disabled:cursor-not-allowed ${
                                activeSide === FeedingSide.Right ? 'bg-red-600' : 'bg-rose-400'
                            }`}
                        >
                            R
                        </button>
                    </div>
                </div>
            );
        }

        // ============================================
        // PAGES - DailySummaryPage
        // ============================================
        function DailySummaryPage({ history }) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const stats = calculateDailyStats(history, today);

            if (stats.totalFeeds === 0) {
                return (
                    <div className="flex items-center justify-center h-full">
                        <div className="text-slate-500 text-lg">No feeds recorded today</div>
                    </div>
                );
            }

            return (
                <div className="p-4">
                    <h2 className="text-2xl font-bold text-slate-800 mb-6">Today's Summary</h2>
                    <div className="grid grid-cols-2 gap-4">
                        <StatCard title="Total Feeds" value={stats.totalFeeds} />
                        <StatCard title="Total Time" value={<TimerDisplay seconds={stats.totalTime} />} />
                        <StatCard title="Left Side" value={<TimerDisplay seconds={stats.leftTime} />} />
                        <StatCard title="Right Side" value={<TimerDisplay seconds={stats.rightTime} />} />
                    </div>
                </div>
            );
        }

        // ============================================
        // PAGES - MonthlySummaryPage
        // ============================================
        function MonthlySummaryPage({ history }) {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            const stats = calculateMonthlyStats(history, currentMonth, currentYear);

            if (stats.totalFeeds === 0) {
                return (
                    <div className="flex items-center justify-center h-full">
                        <div className="text-slate-500 text-lg">No feeds recorded this month</div>
                    </div>
                );
            }

            return (
                <div className="p-4">
                    <h2 className="text-2xl font-bold text-slate-800 mb-6">This Month's Summary</h2>
                    <div className="grid grid-cols-2 gap-4">
                        <StatCard title="Total Feeds" value={stats.totalFeeds} />
                        <StatCard title="Avg Feeds/Day" value={stats.avgFeedsPerDay} />
                    </div>
                </div>
            );
        }

        // ============================================
        // PAGES - NotificationsPage
        // ============================================
        function NotificationsPage({ lastFeedTime }) {
            const [permission, setPermission] = useState(Notification.permission);
            const [hours, setHours] = useState(3);
            const [minutes, setMinutes] = useState(0);
            const [reminderTimeoutId, setReminderTimeoutId] = useState(null);
            const [reminderTime, setReminderTime] = useState(null);

            const requestPermission = async () => {
                const result = await Notification.requestPermission();
                setPermission(result);
            };

            const setReminder = () => {
                if (!lastFeedTime || permission !== 'granted') return;

                const reminderMs = (hours * 60 + minutes) * 60 * 1000;
                const targetTime = lastFeedTime + reminderMs;
                const delay = targetTime - Date.now();

                if (delay > 0) {
                    const timeoutId = setTimeout(() => {
                        new Notification('Time for the next feed!');
                        setReminderTimeoutId(null);
                        setReminderTime(null);
                    }, delay);

                    setReminderTimeoutId(timeoutId);
                    setReminderTime(targetTime);
                }
            };

            const clearReminder = () => {
                if (reminderTimeoutId) {
                    clearTimeout(reminderTimeoutId);
                    setReminderTimeoutId(null);
                    setReminderTime(null);
                }
            };

            return (
                <div className="p-4">
                    <h2 className="text-2xl font-bold text-slate-800 mb-6">Feed Reminders</h2>

                    {permission !== 'granted' && (
                        <div className="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded-lg mb-6">
                            <p className="mb-2">Notification permission is required to set reminders.</p>
                            <button
                                onClick={requestPermission}
                                className="px-4 py-2 bg-yellow-600 text-white rounded-lg"
                            >
                                Enable Notifications
                            </button>
                        </div>
                    )}

                    <div className="bg-white p-6 rounded-lg shadow-lg">
                        <div className="mb-4">
                            <label className="block text-sm font-semibold text-slate-700 mb-2">Remind me in:</label>
                            <div className="flex gap-4">
                                <div>
                                    <input
                                        type="number"
                                        min="0"
                                        value={hours}
                                        onChange={(e) => setHours(parseInt(e.target.value) || 0)}
                                        className="w-20 px-3 py-2 border border-slate-300 rounded-lg text-center"
                                    />
                                    <span className="ml-2 text-slate-600">hours</span>
                                </div>
                                <div>
                                    <input
                                        type="number"
                                        min="0"
                                        max="59"
                                        value={minutes}
                                        onChange={(e) => setMinutes(parseInt(e.target.value) || 0)}
                                        className="w-20 px-3 py-2 border border-slate-300 rounded-lg text-center"
                                    />
                                    <span className="ml-2 text-slate-600">minutes</span>
                                </div>
                            </div>
                        </div>

                        <button
                            onClick={setReminder}
                            disabled={permission !== 'granted' || !lastFeedTime}
                            className="w-full px-4 py-3 bg-violet-500 text-white rounded-lg font-semibold disabled:bg-slate-300 disabled:cursor-not-allowed active:scale-95 transition-transform"
                        >
                            Set Reminder
                        </button>

                        {reminderTime && (
                            <div className="mt-4 p-4 bg-green-100 rounded-lg">
                                <p className="text-green-800 mb-2">
                                    Reminder set for {new Date(reminderTime).toLocaleTimeString()}
                                </p>
                                <button
                                    onClick={clearReminder}
                                    className="px-4 py-2 bg-red-500 text-white rounded-lg"
                                >
                                    Clear Reminder
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // ============================================
        // MAIN APP
        // ============================================
        function App() {
            const [currentPage, setCurrentPage] = useState('Tracker');
            const { activeSide, duration, startTimer, stopTimer } = useTimer();
            const { history, addFeed, clearHistory, lastFeedTime, chronologicalHistory } = useFeedingHistory();

            useEffect(() => {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('sw.js');
                }
            }, []);

            const renderPage = () => {
                switch (currentPage) {
                    case 'Tracker':
                        return (
                            <TrackerPage
                                activeSide={activeSide}
                                duration={duration}
                                startTimer={startTimer}
                                stopTimer={stopTimer}
                                addFeed={addFeed}
                                clearHistory={clearHistory}
                                chronologicalHistory={chronologicalHistory}
                            />
                        );
                    case 'Daily':
                        return <DailySummaryPage history={history} />;
                    case 'Monthly':
                        return <MonthlySummaryPage history={history} />;
                    case 'Notify':
                        return <NotificationsPage lastFeedTime={lastFeedTime} />;
                    default:
                        return null;
                }
            };

            return (
                <div className="h-screen bg-gray-100 flex flex-col font-sans">
                    <header className="p-4 text-center">
                        <h1 className="text-3xl font-bold bg-gradient-to-r from-violet-400 to-rose-400 bg-clip-text text-transparent">
                            Baby Feed Tracker
                        </h1>
                    </header>

                    <main className="flex-grow overflow-hidden pb-20">
                        {renderPage()}
                    </main>

                    <nav className="fixed bottom-0 left-0 right-0 bg-white shadow-[0_-2px_10px_rgba(0,0,0,0.1)]">
                        <div className="flex justify-around items-center py-2">
                            <button
                                onClick={() => setCurrentPage('Tracker')}
                                className={`flex flex-col items-center p-2 ${currentPage === 'Tracker' ? 'text-violet-500' : 'text-slate-500'}`}
                            >
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span className="text-xs mt-1">Tracker</span>
                            </button>
                            <button
                                onClick={() => setCurrentPage('Daily')}
                                className={`flex flex-col items-center p-2 ${currentPage === 'Daily' ? 'text-violet-500' : 'text-slate-500'}`}
                            >
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                <span className="text-xs mt-1">Daily</span>
                            </button>
                            <button
                                onClick={() => setCurrentPage('Monthly')}
                                className={`flex flex-col items-center p-2 ${currentPage === 'Monthly' ? 'text-violet-500' : 'text-slate-500'}`}
                            >
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                </svg>
                                <span className="text-xs mt-1">Monthly</span>
                            </button>
                            <button
                                onClick={() => setCurrentPage('Notify')}
                                className={`flex flex-col items-center p-2 ${currentPage === 'Notify' ? 'text-violet-500' : 'text-slate-500'}`}
                            >
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                                </svg>
                                <span className="text-xs mt-1">Notify</span>
                            </button>
                        </div>
                    </nav>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
